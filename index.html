<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WØRTLE</title>
<style>
  body {
    font-family: Trebuchet MS, Helvetica, Arial, sans-serif;
    text-align: center;
    background-color: #01222e;
    color: white;
    margin:0 auto;
  }
  #game {
    display: none;
    flex-direction: column;
    align-items: center;
    transition: opacity 0.5s ease-in-out;
  }
#game.dimmed {
    opacity: 0.5;
    pointer-events: none; /* Disables interaction with dimmed elements */
}
  .board {
    display: grid;
    grid-template-rows: repeat(6, 1fr);
    gap: 5px;
    margin: 20px;
  }
  .row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 5px;
  }
  .tile {
    box-shadow: 2px 2px 2px #732b2b;
    width: 60px;
    height: 60px;
    border: 3px solid #041c47;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2em;
    font-weight: bold;
    text-transform: uppercase;
    background-color: #121213;
    color: white;
    border-radius:5px;
    transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
  }
  .correct { background-color: #538d4e !important; }
  .present { background-color: #b59f3b !important; }
  .absent { background-color: #3a3a3c !important; }
  .keyboard {
    display: flex;
    flex-direction: column;
    gap: 5px;
    max-width: 600px;
    margin-top:20px;
    margin-bottom:20px;
  }
  .key-row {
    display: flex;
    justify-content: center;
    gap: 5px;
  }
  .key {
    padding: 10px;
    background-color: #818384;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    font-weight: bold;
    color: white;
    user-select: none;
  }
  #hintBtn1, #hintBtn2, #hintBtn3, #hintBtn4 {
    background: rgb(3, 39, 93);
    border: 2px solid rgb(14, 12, 43);
    border-radius:5px;
    margin-bottom: 5px;
    cursor: pointer;
    padding:0px 15px 0px 15px;
    display: none;
    color: #c7d1d5;
    font-size: 10pt;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: color 0.3s ease;
  }

.hint-button {
  display: none;
}


  #hintButtons button {
    align-items: center;
    justify-content: center; /* Center content horizontally */
    gap: 10px;
    padding: 0 15px; /* Use horizontal padding to control width */
    letter-spacing: 1pt;
    font-weight: bold;
    background: rgb(3, 39, 93);
    border: 2px solid rgb(14, 12, 43);
    border-left: 4px solid rgb(14, 12, 43);
    box-shadow: 0 0.2rem rgb(14, 12, 43);
    border-radius: 10px;
    margin: 4px 2px 4px 2px;
    cursor: pointer;
    color: #c7d1d5;
    font-size: 10pt;
    transition: max-width 0.5s ease-in-out, background-color 0.3s ease;
    max-width: 250px; /* Start with a generous initial max-width */
    overflow: hidden;
    height: 50px;
    white-space: nowrap; /* Prevent text from wrapping */
  }

  #hintButtons button.expanded {
    max-width: 9999px; /* A very large value to allow expansion */
    justify-content: flex-start; /* Align content to the left when expanded */
    padding-right: 15px;
  }
  #hintButtons button:disabled {
  cursor: default;
  opacity: 1;
}

  .hint-label {
    flex-shrink: 0;
    transition: margin-right 0.5s ease-in-out;
  }
  
  .hint-label.hidden {
      margin-right: 10px;
  }

  .hint-text {
    font-style: italic;
    text-transform: uppercase;
    font-weight: normal;
    white-space: normal;
    opacity: 0;
    max-width: 0;
    transition: opacity 0.5s ease 0.3s, max-width 0.5s ease 0.3s;
    flex-grow: 1;
    margin-left: auto;
  }

  .hint-text.visible {
    opacity: 1;
    max-width: 250px;
  }
#hintBtn1:hover, #hintBtn2:hover, #hintBtn3:hover, #hintBtn4:hover,
#hintBtn1.clicked-hint, #hintBtn2.clicked-hint, #hintBtn3.clicked-hint, #hintBtn4.clicked-hint {
  background-color: #070a23;
  transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
}
.styled-button {
    background-color: #e4e4e4;
    border: none;
    font-weight: bold;
    width: 10em;
    border-radius: 1rem;
    color: rgb(35, 35, 35);
    box-shadow: 0 0.2rem #1d1d1d;
    border: 2px solid #1d1d1d;
    cursor: pointer;
    margin: 5px auto;
}
  #modalCopyBtn, #showStatsBtn {
    background-color: #e4e4e4;
    border: none;
    padding: 10px;
    font-weight: bold;
    font-size: 10pt;
    width: 10em;
    border-radius: 1rem;
    color: rgb(35, 35, 35);
    box-shadow: 0 0.4rem #1d1d1d;
    border: 2px solid #1d1d1d;
    cursor: pointer;
    margin: 5px auto;
  }
  #modalCopyBtn:hover, #showStatsBtn:hover, .styled-button:hover {
    background-color: #e97251;
    color: #e9e9e9;
    transition: background-color 0.1s ease-in-out, color 0.1s ease-in-out;
  }
  #modal-stats-display {
    text-align: center;
  }
  h1 { 
    letter-spacing: 1pt; 
    border-bottom:1px solid rgb(34, 65, 78);
    padding:1.4rem;
    margin:0;
    background-color:rgb(3, 22, 27);
    font-family: monospace;
  }
  .modal {
    display: none;
    position: fixed;
    z-index: 100;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    align-items: center;
    justify-content: center;
  }
  #modal-message { font-size: 16pt; width:250px; font-family:monospace; }
  .modal.show { display: flex; }
  .modal-content {
    width:250px;
    background-color: #e1dbd9;
    border:1px solid rgb(49, 49, 49);
    background-image: linear-gradient(to top, rgb(206, 86, 17) 20px, transparent 20px); /* Blue stripe 5px high at the top */
    background-repeat: no-repeat;
    background-position: top;
    background-size: 100% 20px; /* Ensures the stripe spans the full width and is 5px high */
    border-radius:10px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    gap: 15px;
    color: rgb(33, 33, 33);
  }
  #modal-summary {
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 1.2em;
    margin: 10px 0;
    color: rgb(33, 33, 33);
    letter-spacing: 2pt;
  }
  #hintButtonsContainer {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 3px;
    margin-top: 5px;
  }
  #secretWordColor {
  color: #cd1616; /* Example: a bright orange color */
}
.host-input {
  background: #021a24;
  color: #c7d1d5;
  border: none;
  padding: 8px;
  border-radius: 6px;
  width: 200px;
  display: block;
  margin: auto;
  margin-top: 5px;
  margin-bottom: 5px;
  text-align: center;
  transition: background 0.2s ease; /* Smooth color change */
}

.host-input::placeholder {
  color: #6f8a94;
}
.host-input:not(:placeholder-shown) {
  background: #010f15;
}
#hintInput4Container {
  margin: auto;
  margin-top: 5px;
  margin-bottom: 5px;
  display: block;
  text-align: left;
  background: #021a24;
  padding: 8px;
  width: 200px;
  border-radius: 6px;
  text-align:center;
  transition: background 0.2s ease; /* Smooth color change */
}

#hintInput4Container.darkened {
  background: #010f15;
}
#secretInput {
  text-transform: uppercase;
}

#modal-stats-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out;
    background-color: #d8d8d8;
    color: #333;
    padding: 0 10px;
    border-radius: 8px;
  }

  #modal-stats-container.expanded {
    max-height: 500px;
  }

  .stats-line {
    margin: 5px 0;
    font-family: monospace;
  }

  .button-group {
    display: inline-block;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    align-items: center;
  }
  
  .key:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  #topStatsDisplay, #username-display-area {
    transition: opacity 0.2s;
    text-shadow:2px 2px #000000;
    font-size: 0.9em;
  }
    /* Add the keyframe animation */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
  }

  /* Add the class to apply the animation */
  .shake {
    animation: shake 0.5s ease-in-out;
  }
</style>
</head>
<body>

<h1><span style="color:rgb(243, 202, 186);">Cross-Germanic</span> WØRTLE</h1>

<div id="header-info" style="display: flex; justify-content: space-between; align-items: center; max-width: 750px; margin: 10px auto; padding: 0 10px;">
<div id="username-display-area" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align: left; width:180px;">
  </div>
  <div id="topStatsDisplay" style="padding:0 5px;">
    </div>
  <div id="change-user-button-area" style="text-align: center; width:180px;">
    </div>
</div>
<div id="setup">
  <p style="margin-bottom:20px;">Host: Enter a secret word and optional hints for the user to reveal</p>
  <input type="text" id="secretInput" maxlength="5" placeholder="Secret word" class="host-input"/>
  <input type="text" id="hintInput" placeholder="Language" class="host-input"/>
  <input type="text" id="hintInput2" placeholder="Part of speech" class="host-input"/>
  <input type="text" id="hintInput3" placeholder="Context" class="host-input"/>
<div id="hintInput4Container">
  <p style="margin:0 0 5px 0; font-size:0.9em; color:#c7d1d5;">Special character(s)</p>
  <label style="display:block; margin-bottom:4px; cursor:pointer;">
    <input type="checkbox" value="Ä" class="specialCharCheckbox"> Ä
  </label>
  <label style="display:block; margin-bottom:4px; cursor:pointer;">
    <input type="checkbox" value="Ö" class="specialCharCheckbox"> Ö
  </label>
  <label style="display:block; margin-bottom:4px; cursor:pointer;">
    <input type="checkbox" value="Ü" class="specialCharCheckbox"> Ü
  </label>
  <label style="display:block; margin-bottom:4px; cursor:pointer;">
    <input type="checkbox" value="ẞ" class="specialCharCheckbox"> ẞ
  </label>
  <label style="display:block; margin-bottom:4px; cursor:pointer;">
    <input type="checkbox" value="Æ" class="specialCharCheckbox"> Æ
  </label>
  <label style="display:block; margin-bottom:4px; cursor:pointer;">
    <input type="checkbox" value="Ø" class="specialCharCheckbox"> Ø
  </label>
  <label style="display:block; margin-bottom:4px; cursor:pointer;">
    <input type="checkbox" value="Å" class="specialCharCheckbox"> Å
  </label>
</div>
  <button onclick="startGame()">Start Game</button>
  <p id="urlShare"></p>
</div>

<div id="game">
  <p id="message"></p>
  <button id="copyBtn" style="display:none; margin:5px;" onclick="copyResult()">Copy Result</button>
  <div id="board" class="board"></div>

<div id="hintButtons" style="width:80%; gap:10px; justify-content:center; margin-top:5px; display: none;">
  <div id="hintTitle" style="display: none; text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 1em; letter-spacing: 1pt;">Need a hint?</div>
  <div id="hintButtonsContainer">
    <button id="hintBtn1" class="hint-button" onclick="showHint(1)" aria-label="Show Hint 1" title="Show Hint 1" style="display: none;">
      <span class="hint-label">Language</span>
      <span class="hint-text"></span>
    </button>
    <button id="hintBtn2" class="hint-button" onclick="showHint(2)" aria-label="Show Hint 2" title="Show Hint 2" style="display: none;">
      <span class="hint-label">Part Of Speech</span>
      <span class="hint-text"></span>
    </button>
    <button id="hintBtn3" class="hint-button" onclick="showHint(3)" aria-label="Show Hint 3" title="Show Hint 3" style="display: none;">
      <span class="hint-label">Context</span>
      <span class="hint-text"></span>
    </button>
    <button id="hintBtn4" class="hint-button" onclick="showHint(4)" aria-label="Show Hint 4" title="Show Hint 4" style="display: none;">
        <span class="hint-label">Reveal Special Character(s)</span>
        <span class="hint-text"></span>
    </button>
  </div>
</div>

  <div id="keyboard" class="keyboard"></div>
</div>

<div id="game-over-modal" class="modal">
  <div class="modal-content">
    <p id="modal-message"></p>
    <div id="modal-summary"></div>
    <div class="button-group">
      <button id="showStatsBtn">Show My Stats</button>
      <div id="modal-stats-container">
          </div>
      <button id="modalCopyBtn" onclick="copySavedResult()">Copy Result</button>
    </div>
  </div>
</div>

<script>
let secret = "";
let customHint1 = "";
let customHint2 = "";
let customHint3 = "";
let customHint4 = "";
let hintUsed1 = false;
let hintUsed2 = false;
let hintUsed3 = false;
let hintUsed4 = false;
let currentRow = 0;
let currentCol = 0;
const rows = 6;
const cols = 5;
let grid = [];
let keyColors = {};
let guessHistory = [];
let colorHistory = [];
let usernameSet = false;
let isAnimating = false;

// Base64 helpers
function base64Encode(str) { return btoa(unescape(encodeURIComponent(str))); }
function base64Decode(str) { try { return decodeURIComponent(escape(atob(str))); } catch { return null; } }

function getSecretFromURL() {
  const params = new URLSearchParams(window.location.search);
  const encodedWord = params.get("w");
  const encodedHint1 = params.get("h1");
  const encodedHint2 = params.get("h2");
  const encodedHint3 = params.get("h3");
  const encodedHint4 = params.get("h4");
  if (!encodedWord) return null;
  const decodedWord = base64Decode(encodedWord);

  customHint1 = encodedHint1 ? base64Decode(encodedHint1) : "";
  customHint2 = encodedHint2 ? base64Decode(encodedHint2) : "";
  customHint3 = encodedHint3 ? base64Decode(encodedHint3) : "";
  customHint4 = encodedHint4 ? base64Decode(encodedHint4) : "";

  if (decodedWord && /^[A-ZÆØÅÄÖÜẞ]{5}$/.test(decodedWord)) {
    return decodedWord.toUpperCase();
  }
  return null;
}

const hintContainer = document.getElementById("hintInput4Container");
const specialCharBoxes = document.querySelectorAll(".specialCharCheckbox");

function updateHintContainerBackground() {
  const anyChecked = Array.from(specialCharBoxes).some(cb => cb.checked);
  hintContainer.classList.toggle("darkened", anyChecked);
}

specialCharBoxes.forEach(cb => {
  cb.addEventListener("change", updateHintContainerBackground);
});


function updateURLWithWord(word, hint1, hint2, hint3, hint4) {
  const url = new URL(window.location);
  url.searchParams.set("w", base64Encode(word));
  if (hint1) url.searchParams.set("h1", base64Encode(hint1));
  if (hint2) url.searchParams.set("h2", base64Encode(hint2));
  if (hint3) url.searchParams.set("h3", base64Encode(hint3));
  if (hint4) url.searchParams.set("h4", base64Encode(hint4));
  window.history.replaceState({}, "", url);
  document.getElementById("urlShare").textContent = `Share this link to play: ${url.href}`;
}

function getStats(username) {
  const stats = JSON.parse(localStorage.getItem("gerNordleStats") || "{}");
  return stats[username] || { gamesPlayed: 0, wins: 0, totalGuesses: 0 };
}

function saveStats(username, stats) {
  const allStats = JSON.parse(localStorage.getItem("gerNordleStats") || "{}");
  allStats[username] = stats;
  localStorage.setItem("gerNordleStats", JSON.stringify(allStats));
}

function updateStats(username, won, guesses) {
  const user = username || "Player";
  const stats = getStats(user);
  stats.gamesPlayed++;
  if (won) {
    stats.wins++;
    stats.totalGuesses += guesses;
  }
  saveStats(user, stats);
}

function displayStats(username) {
  const user = username || "Player";
  const stats = getStats(user);
  let avgGuesses = stats.wins > 0 ? (stats.totalGuesses / stats.wins).toFixed(2) : "-";
  let winPct = stats.gamesPlayed > 0 ? ((stats.wins / stats.gamesPlayed) * 100).toFixed(1) : "0.0";
  
  return [
    `Stats for ${user}`,
    `Games Played: ${stats.gamesPlayed}`,
    `Wins: ${stats.wins}`,
    `Win %: ${winPct}%`,
    `Average Guesses: ${avgGuesses}`
  ];
}

function startGame() {
  const inputWord = document.getElementById("secretInput").value.trim().toUpperCase();
  const inputHint1 = document.getElementById("hintInput").value.trim();
  const inputHint2 = document.getElementById("hintInput2").value.trim();
  const inputHint3 = document.getElementById("hintInput3").value.trim();
  const inputHint4 = Array.from(document.querySelectorAll(".specialCharCheckbox:checked"))
                        .map(cb => cb.value)
                        .join(", ");
  
  if (!inputWord) { alert("Please enter a secret word."); return; }
  
  // The word is now already uppercase due to .toUpperCase()
  if (inputWord.length !== 5 || !/^[A-ZÄÖÜßẞÆØÅ]+$/i.test(inputWord)) {
    alert("Secret word must be exactly 5 letters and can include Ä, Ö, Ü, ß, ẞ, Æ, Ø, Å.");
    return;
  }
  
  secret = inputWord;
  customHint1 = inputHint1;
  customHint2 = inputHint2;
  customHint3 = inputHint3;
  customHint4 = inputHint4;
  updateURLWithWord(secret, customHint1, customHint2, customHint3, customHint4);
  
  document.getElementById("setup").style.display = "none";
  document.getElementById("game").style.display = "flex";
  
  checkUserStatus();
}

function checkUserStatus() {
  const savedUsername = localStorage.getItem("gerNordleUsername");
  const usernameDisplayArea = document.getElementById("username-display-area");
  const topStatsDisplay = document.getElementById("topStatsDisplay");
  const changeUserButtonArea = document.getElementById("change-user-button-area");
  const gameElement = document.getElementById("game");

  usernameDisplayArea.innerHTML = '';
  topStatsDisplay.innerHTML = '';
  changeUserButtonArea.innerHTML = '';

  const isSolved = savedUsername && secret && localStorage.getItem("gerNordleSolved") === secret;
  const isLost = savedUsername && secret && localStorage.getItem("gerNordleLost") === secret;

  if (isSolved || isLost) {
    document.getElementById("message").textContent = isSolved ? "You already solved this Wordle! 🥳" : "You have already played this Wordle.";
    gameElement.classList.add("dimmed");

    const savedGuessHistory = JSON.parse(localStorage.getItem("gerNordleGuessHistory"));
    const savedColorHistory = JSON.parse(localStorage.getItem("gerNordleColorHistory"));
    const savedHintStatus = JSON.parse(localStorage.getItem("gerNordleHintStatus"));

    const modal = document.getElementById("game-over-modal");
    if (isSolved) {
        document.getElementById("modal-message").textContent = "You win! 🎉";
    } else {
        document.getElementById("modal-message").innerHTML = `Game over! The secret word was <span id="secretWordColor">${secret}</span>.`;
    }

    document.getElementById("modal-summary").textContent = generateResultText(true, savedGuessHistory, savedColorHistory, isSolved, savedHintStatus);
    
    document.getElementById("modalCopyBtn").onclick = function() {
      if (savedGuessHistory && savedColorHistory) {
        const resultText = generateResultText(false, savedGuessHistory, savedColorHistory, isSolved, savedHintStatus);
        navigator.clipboard.writeText(resultText);
        alert("Result copied to clipboard!");
      } else {
        alert("No solved game data to copy.");
      }
    };
    
    document.getElementById("modalCopyBtn").style.display = "block";

    const statsContainer = document.getElementById("modal-stats-container");
    statsContainer.innerHTML = "";
    const statsLines = displayStats(savedUsername);
    statsLines.forEach(line => {
      const p = document.createElement('p');
      p.textContent = line;
      p.classList.add('stats-line');
      statsContainer.appendChild(p);
    });
    modal.classList.add("show");

    document.getElementById("showStatsBtn").addEventListener("click", function() {
      const statsContainer = document.getElementById("modal-stats-container");
      statsContainer.classList.toggle('expanded');
      this.textContent = statsContainer.classList.contains('expanded') ? "Hide My Stats" : "Show My Stats";
    });

    return;
  }

  // If the game has not been solved or lost, continue with the normal setup
  if (savedUsername) {
    window.currentUsername = savedUsername;
    usernameSet = true;

    const displayMessage = document.createElement("p");
    displayMessage.textContent = `Playing as: ${savedUsername.toUpperCase()}`;
    displayMessage.style.cssText = "margin: 0;";
    usernameDisplayArea.appendChild(displayMessage);

    const changeButton = document.createElement("button");
    changeButton.textContent = "Change User";
    changeButton.onclick = promptForUsername;
    changeButton.classList.add("styled-button");
    changeUserButtonArea.appendChild(changeButton);

    const stats = getStats(savedUsername);
    let avgGuesses = stats.wins > 0 ? (stats.totalGuesses / stats.wins).toFixed(2) : "-";
    let winPct = stats.gamesPlayed > 0 ? ((stats.wins / stats.gamesPlayed) * 100).toFixed(1) : "0.0";

    topStatsDisplay.innerHTML = `Games Played: ${stats.gamesPlayed} | Win %: ${winPct}% | Avg. Guesses: ${avgGuesses}`;
    topStatsDisplay.style.display = "block";

    gameElement.classList.remove("dimmed");

  } else {
    promptForUsername();
    gameElement.classList.add("dimmed");
  }

  const hintButtonsContainer = document.getElementById("hintButtonsContainer");
  const hintTitle = document.getElementById("hintTitle");
  const hintBtn1 = document.getElementById("hintBtn1");
  const hintBtn2 = document.getElementById("hintBtn2");
  const hintBtn3 = document.getElementById("hintBtn3");
  const hintBtn4 = document.getElementById("hintBtn4");

  if (customHint1 && customHint1.trim() !== "") {
    hintBtn1.style.display = "inline-flex";
  }
  if (customHint2 && customHint2.trim() !== "") {
    hintBtn2.style.display = "inline-flex";
  }
  if (customHint3 && customHint3.trim() !== "") {
    hintBtn3.style.display = "inline-flex";
  }
  if (customHint4 && customHint4.trim() !== "") {
    hintBtn4.style.display = "inline-flex";
  }

  if (hintBtn1.style.display !== "none" || hintBtn2.style.display !== "none" || hintBtn3.style.display !== "none" || hintBtn4.style.display !== "none") {
    document.getElementById("hintButtons").style.display = "block";
    hintButtonsContainer.style.display = "flex";
    hintTitle.style.display = "block";
  }

  hintUsed1 = false;
  hintUsed2 = false;
  hintUsed3 = false;
  hintUsed4 = false;
  document.getElementById("message").textContent = "";
  document.getElementById("copyBtn").style.display = "none";
  grid = Array(rows).fill(null).map(() => Array(cols).fill(""));
  guessHistory = [];
  colorHistory = [];
  keyColors = {};
  currentRow = 0;
  currentCol = 0;
  isAnimating = false;
  initBoard();
  initKeyboard();
}

function promptForUsername() {
  const usernameDisplayArea = document.getElementById("username-display-area");
  const topStatsDisplay = document.getElementById("topStatsDisplay");
  const changeUserButtonArea = document.getElementById("change-user-button-area");

  // Clear the content of all three sections
  usernameDisplayArea.innerHTML = '';
  topStatsDisplay.innerHTML = '';
  changeUserButtonArea.innerHTML = '';

  const usernameInput = document.createElement("input");
  usernameInput.type = "text";
  usernameInput.id = "usernameInputGame";
  usernameInput.placeholder = "Enter username";
  usernameInput.style.cssText = "padding: 6px; border-radius: 6px; width: 180px;";

  const setButton = document.createElement("button");
  setButton.textContent = "Set Username";
  setButton.onclick = setUsername;
  setButton.classList.add("styled-button");
  setButton.style.width = "10em";
  setButton.style.margin = "5px auto";

  // Use the middle section to hold and center the input and button
  topStatsDisplay.style.display = "flex";
  topStatsDisplay.style.gap = "8px";
  topStatsDisplay.style.justifyContent = "center";
  topStatsDisplay.style.alignItems = "center";

  topStatsDisplay.appendChild(usernameInput);
  topStatsDisplay.appendChild(setButton);

  window.currentUsername = null;
  usernameSet = false;
  document.getElementById("topStatsDisplay").style.display = "flex";
}

function setUsername() {
  const usernameInput = document.getElementById("usernameInputGame");
  let username = usernameInput.value.trim();

  if (!username) {
    alert("Please enter a username.");
    return;
  }

  username = username.toUpperCase();
  localStorage.setItem("gerNordleUsername", username);

  checkUserStatus();
}

function updateBoard() {
  const board = document.getElementById("board");
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      board.children[r].children[c].textContent = grid[r][c];
    }
  }
}

function handleKeyPress(key) {
  if (!usernameSet || isAnimating) {
    return;
  }
  
  const msgEl = document.getElementById("message");
  if (msgEl.textContent.trim() === "You win! 🎉" || msgEl.textContent.trim() === "Game over!") return;

  const keyButton = document.querySelector(`.key[data-key="${key.toUpperCase()}"]`);
  if (keyButton) {
    keyButton.classList.add("key-pop");
    setTimeout(() => {
      keyButton.classList.remove("key-pop");
    }, 100);
  }

  if (/^[a-zA-ZÄÖÜäöüßẞÆØÅæøå]$/.test(key) && currentCol < cols) {
    let letter = key;
    if (key === "ß") letter = "ẞ";
    else letter = key.toUpperCase();

    grid[currentRow][currentCol] = letter;
    currentCol++;
    updateBoard();
  } else if (key === "Backspace" && currentCol > 0) {
    currentCol--; grid[currentRow][currentCol] = ""; updateBoard();
  } else if (key === "Enter" && currentCol === cols) {
    submitGuess();
  }
}

window.addEventListener("keydown", (e) => {
  if (!usernameSet || isAnimating) return;
  
  if (document.getElementById("game").style.display !== "flex") return;
  const key = e.key.toUpperCase();
  if (key === "BACKSPACE") {
    handleKeyPress("Backspace");
  } else if (key === "ENTER") {
    handleKeyPress("Enter");
  } else if (/^[A-ZÄÖÜßẞÆØÅ]$/.test(key)) {
    const keyToPass = key === 'ß' ? 'ẞ' : key;
    handleKeyPress(keyToPass);
  }
});

function validateHardMode(guess) {
  for (let i = 0; i < guessHistory.length; i++) {
    const prevGuess = guessHistory[i];
    const colors = colorHistory[i];
    
    for (let j = 0; j < cols; j++) {
      if (colors[j] === "correct" && guess[j] !== prevGuess[j]) {
        document.getElementById("message").textContent = `Hard mode violation: Letter '${prevGuess[j]}' must be in position ${j+1}`;
        return false;
      }
    }

    const presentLetters = {};
    for (let j = 0; j < cols; j++) {
      if (colors[j] === "present") {
        presentLetters[prevGuess[j]] = (presentLetters[prevGuess[j]] || 0) + 1;
      }
    }
    for (const letter in presentLetters) {
      const countInGuess = [...guess].filter(l => l === letter).length;
      if (countInGuess < presentLetters[letter]) {
        document.getElementById("message").textContent = `Hard mode violation: Guess must include letter '${letter}' at least ${presentLetters[letter]} time(s)`;
        return false;
      }
    }

    for (let j = 0; j < cols; j++) {
      if (colors[j] === "absent") {
        const absentLetter = prevGuess[j];
        const isElsewherePresentOrCorrect = colors.some((color, idx) => 
          (color === "correct" || color === "present") && prevGuess[idx] === absentLetter);
        if (!isElsewherePresentOrCorrect) {
          if (guess.includes(absentLetter)) {
            document.getElementById("message").textContent = `Hard mode violation: Letter '${absentLetter}' cannot be used`;
            return false;
          }
        }
      }
    }
  }
  document.getElementById("message").textContent = "";
  return true;
}


function submitGuess() {
  const guess = grid[currentRow].join("");
  if (guess.length !== cols) {
    const currentRowDiv = document.getElementById("board").children[currentRow];
    if (currentRowDiv) {
      currentRowDiv.classList.add("shake");
      setTimeout(() => {
        currentRowDiv.classList.remove("shake");
      }, 500); 
    }
    document.getElementById("message").textContent = "Not enough letters";
    return;
  }
  
  if (!validateHardMode(guess)) {
    const currentRowDiv = document.getElementById("board").children[currentRow];
    if (currentRowDiv) {
      currentRowDiv.classList.add("shake");
      setTimeout(() => {
        currentRowDiv.classList.remove("shake");
      }, 500); 
    }
    return;
  }
  
  isAnimating = true;
  
  guessHistory.push(guess);
  const colors = Array(cols).fill("absent");
  const secretLetters = secret.split("");
  for (let i = 0; i < cols; i++) {
    if (guess[i] === secret[i]) { colors[i] = "correct"; secretLetters[i] = null; }
  }
  for (let i = 0; i < cols; i++) {
    if (colors[i] === "correct") continue;
    const index = secretLetters.indexOf(guess[i]);
    if (index !== -1) { colors[i] = "present"; secretLetters[index] = null; }
  }
    for (let i = 0; i < cols; i++) {
    const letter = guess[i];
    const color = colors[i];
    if (!keyColors[letter] || 
        (color === "correct") ||
        (color === "present" && keyColors[letter] === "absent")) {
      keyColors[letter] = color;
    }
  }

  updateKeyboardColors();
  
  colorHistory.push(colors);
  const board = document.getElementById("board");
  for (let i = 0; i < cols; i++) {
    const tile = board.children[currentRow].children[i];
    setTimeout(() => {
      tile.classList.add("flip");
      setTimeout(() => {
        tile.classList.remove("flip");
        tile.classList.add(colors[i]);
        tile.classList.add("flipped");
      }, 150);
    }, i * 150);
  }
  setTimeout(() => {
    const modal = document.getElementById("game-over-modal");

    let gameIsOver = false;
    let didWin = false; // Declare a variable to store the win/loss status
    
    if (guess === secret) {
      document.getElementById("modal-message").textContent = "You win! 🎉";
      updateStats(window.currentUsername, true, guessHistory.length);
      localStorage.setItem("gerNordleSolved", secret);
      localStorage.setItem("gerNordleGuessHistory", JSON.stringify(guessHistory));
      localStorage.setItem("gerNordleColorHistory", JSON.stringify(colorHistory));
      gameIsOver = true;
      didWin = true; // Set to true on a win
    }
    else if (currentRow === rows - 1) {
      document.getElementById("modal-message").innerHTML = `Game over! The secret word was <span id="secretWordColor">${secret}</span>.`;
      updateStats(window.currentUsername, false, guessHistory.length);
      localStorage.setItem("gerNordleLost", secret);
      localStorage.setItem("gerNordleGuessHistory", JSON.stringify(guessHistory));
      localStorage.setItem("gerNordleColorHistory", JSON.stringify(colorHistory));
      gameIsOver = true;
      didWin = false; // Set to false on a loss
    }
    
    if (gameIsOver) {
      // Save hint status to local storage
      localStorage.setItem("gerNordleHintStatus", JSON.stringify({
        hintUsed1: hintUsed1,
        hintUsed2: hintUsed2,
        hintUsed3: hintUsed3,
        hintUsed4: hintUsed4
      }));
      const savedHintStatus = JSON.parse(localStorage.getItem("gerNordleHintStatus"));
      // Pass the didWin flag here so generateResultText() knows to use X/6
      document.getElementById("modal-summary").textContent = generateResultText(true, guessHistory, colorHistory, didWin); 
      const statsContainer = document.getElementById("modal-stats-container");
      statsContainer.innerHTML = "";
      const statsLines = displayStats(window.currentUsername);
      statsLines.forEach(line => {
          const p = document.createElement('p');
          p.textContent = line;
          p.classList.add('stats-line');
          statsContainer.appendChild(p);
      });
      modal.classList.add("show");
      document.getElementById("modalCopyBtn").style.display = "block";
    
      document.getElementById("showStatsBtn").addEventListener("click", function() {
        const statsContainer = document.getElementById("modal-stats-container");
        statsContainer.classList.toggle('expanded');
        this.textContent = statsContainer.classList.contains('expanded') ? "Hide My Stats" : "Show My Stats";
      });
    } else {
      currentRow++;
      currentCol = 0;
      isAnimating = false;
    }

  }, (cols * 150) + 200);
}
function copySavedResult() {
  const savedGuessHistory = JSON.parse(localStorage.getItem("gerNordleGuessHistory"));
  const savedColorHistory = JSON.parse(localStorage.getItem("gerNordleColorHistory"));
  const didWin = localStorage.getItem("gerNordleSolved") === secret;
  
  if (savedGuessHistory && savedColorHistory) {
    const resultText = generateResultText(false, savedGuessHistory, savedColorHistory, didWin);
    navigator.clipboard.writeText(resultText);
    alert("Result copied to clipboard!");
  } else {
    alert("No solved game data to copy.");
  }
}

function copyResult() {
  const didWin = guessHistory[guessHistory.length - 1] === secret;
  const resultText = generateResultText(false, guessHistory, colorHistory, didWin);
  navigator.clipboard.writeText(resultText);
  alert("Result copied to clipboard!");
}


function generateResultText(includeGuess = true, history = guessHistory, colors = colorHistory, won = true, hintStatus = null) {
  const attempts = won ? history.length : 'X';
  const currentDate = new Date().toLocaleDateString('en-GB', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
  let statusLine = `WØRTLE (${attempts}/${rows})\n${currentDate}`;
  let lines = colors.map((colorArray) => {
    let emojiColors = colorArray.map((color) => {
      if (color === "correct") return "🟩";
      if (color === "present") return "🟨";
      return "⬛";
    }).join("");
    return emojiColors;
  });
  let hintLine = "";

  if (hintStatus) {
      if (hintStatus.hintUsed1) hintLine += "\nHint 1 was used";
      if (hintStatus.hintUsed2) hintLine += "\nHint 2 was used";
      if (hintStatus.hintUsed3) hintLine += "\nHint 3 was used";
      if (hintStatus.hintUsed4) hintLine += "\nHint 4 was used";
  } else {
      if (hintUsed1) hintLine += "\nHint 1 was used";
      if (hintUsed2) hintLine += "\nHint 2 was used";
      if (hintUsed3) hintLine += "\nHint 3 was used";
      if (hintUsed4) hintLine += "\nHint 4 was used";
  }

  return statusLine + "\n" + lines.join("\n") + hintLine;
}

function showHint(hintNumber) {
    if (!usernameSet) {
        alert("Please enter a username before using hints.");
        return;
    }
    let btn, hintTextValue;
    if (hintNumber === 1) {
        btn = document.getElementById("hintBtn1");
        hintTextValue = customHint1;
        hintUsed1 = true;
    } else if (hintNumber === 2) {
        btn = document.getElementById("hintBtn2");
        hintTextValue = customHint2;
        hintUsed2 = true;
    } else if (hintNumber === 3) {
        btn = document.getElementById("hintBtn3");
        hintTextValue = customHint3;
        hintUsed3 = true;
    } else if (hintNumber === 4) {
        btn = document.getElementById("hintBtn4");
        hintTextValue = customHint4;
        hintUsed4 = true;
    }

    if (btn) {
        if (!btn.classList.contains('expanded')) {
            const hintLabelSpan = btn.querySelector(".hint-label");
            const hintTextSpan = btn.querySelector(".hint-text");

            btn.classList.add("clicked-hint");
            btn.disabled = true;

            hintTextSpan.textContent = hintTextValue;
            btn.offsetWidth;
            btn.classList.add("expanded");
            hintLabelSpan.classList.add('hidden');

            setTimeout(() => {
                hintTextSpan.classList.add('visible');
            }, 300);
        }
    }
}

function initBoard() {
  const board = document.getElementById("board");
  board.innerHTML = "";
  for (let r = 0; r < rows; r++) {
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("row");
    for (let c = 0; c < cols; c++) {
      const tile = document.createElement("div");
      tile.classList.add("tile");
      rowDiv.appendChild(tile);
    }
    board.appendChild(rowDiv);
  }
}

function initKeyboard() {
  const keyboard = document.getElementById("keyboard");
  keyboard.innerHTML = "";
  const layout = [
    ["Q", "W", "E", "R", "T", "Z", "U", "I", "O", "P", "Ü", "Ö", "Ä", "ß"],
    ["A", "S", "D", "F", "G", "H", "J", "K", "L", "Æ", "Ø", "Å"],
    ["Enter", "Y", "X", "C", "V", "B", "N", "M", "Backspace"]
  ];

  layout.forEach(row => {
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("key-row");
    row.forEach(key => {
      const keyButton = document.createElement("button");
      keyButton.textContent = key;
      keyButton.classList.add("key");
      keyButton.setAttribute("data-key", key);
      keyButton.addEventListener("click", () => {
        if (key === "Backspace") handleKeyPress("Backspace");
        else if (key === "Enter") handleKeyPress("Enter");
        else handleKeyPress(key);
      });
      rowDiv.appendChild(keyButton);
    });
    keyboard.appendChild(rowDiv);
  });
}


function updateKeyboardColors() {
  const keys = document.querySelectorAll(".key");
  keys.forEach((keyBtn) => {
    const letter = keyBtn.textContent;
    if (keyColors[letter]) {
      keyBtn.classList.remove("correct", "present", "absent");
      keyBtn.classList.add(keyColors[letter]);
    }
  });
}

window.onload = () => {
  const wordFromURL = getSecretFromURL();
  if (wordFromURL) {
    secret = wordFromURL;
    document.getElementById("setup").style.display = "none";
    document.getElementById("game").style.display = "flex";
    updateURLWithWord(secret, customHint1, customHint2, customHint3, customHint4);
    checkUserStatus(); 
  }
};
</script>
</body>
</html>
